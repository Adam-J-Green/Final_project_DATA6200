# This is a Shiny web application. You can run the application by clicking
# the 'Run App' button above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#
#import libraries
library(ggplot2) # data visualization
library(dplyr) # manipulate data
library(leaflet)
library("ggchicklet")

library(shiny)
library(shinydashboard)
library(reshape2)
library(kableExtra)
library(tidyverse)

#Read Data
data<- read_csv("good_data.csv")
data2<- read_csv("export_df.csv")
#remove government entry mistakes from dataset 
data<- data%>%
  filter(company_name != c("County of Eaton", "City of Porterville"), state != "Pa", state != "Ca", state != "Ne")


#Set window specs for background map
usaLat <- 38
usaLon <- -100.6660877
usaZoom <- 4

#Set icon for map
businessIcon <- makeIcon(
  iconUrl = "1608586_briefcase_icon.png",
  iconWidth = 16, iconHeight = 16
)

#color palette for figures
cbp2 <- c("#D55E00","#56B4E9","#E69F00", 
          "#F0E442", "#009E73", "#0072B2",  "#CC79A7")

#create detect outlier function
detect_outlier <- function(x) {
  
  Quantile1 <- quantile(x, probs=.10)
  Quantile3 <- quantile(x, probs=.90)
  IQR = Quantile3-Quantile1

  x > Quantile3 + (IQR*1.5) | x < Quantile1 - (IQR*1.5)
}
data <- data.frame(data)

#create function to get most common value from character column
getmode <- function(v) {
  uniq <- unique(v)
  uniq[which.max(tabulate(match(v, uniq)))]
}

#remove outliers function
remove_outlier <- function(dataframe,
                            columns=names(dataframe)) {
  
  # for loop to traverse in columns vector
  for (col in columns) {
    
    # remove observation if it satisfies outlier function
    dataframe <- dataframe[!detect_outlier(dataframe[[col]]), ]
  }
  # return dataframe
  return(dataframe)
}

#remove outliers form datasets
data<- remove_outlier(data, c("total_injuries", "total_dafw_days", "total_dafw_cases", "annual_average_employees", "total_hours_worked"))
data2<- remove_outlier(data2, c("total_injuries", "total_dafw_days", "total_dafw_cases", "annual_average_employees", "total_hours_worked"))

# Define UI  using a sidebar layout 
ui <- dashboardPage(
  skin = "blue",
  dashboardHeader(title = "Occupational Health and Safety", titleWidth = 350),
              dashboardSidebar(
                #Create navigation tabs 
                sidebarMenu(id="navMenu", 
                            menuItem("Exploratory Data Analysis", tabName="eda", icon=icon("chart-column")),
                            menuItem("Location Analysis", tabName="location", icon=icon("map")),
                            menuItem("Yearly Trends", tabName="year", icon=icon("chart-line")),
                            menuItem("KPI's", tabName = "kpi", icon=icon("spell-check"))
                    ),
                #Create page one conditional side bar
                conditionalPanel(condition = "input.navMenu == 'eda'",
                                 h4("Exploratory Analysis of OSHA Data"),
                                 p("Welcome to the United States Occupational Health and Safety dashboard. 
                                   On this page you can find exploratory plots and tables related to "),
                                 tags$hr(),
                                 p("Use this selector to specify the indicator used in the injuries plot"),
                                 radioButtons(
                                   inputId = "disp",
                                   label = "Indicator for Injuries Tab",
                                   choices = c( "Total Injuries", "Days Away from Work"),
                                   selected = c("Total Injuries")
                                 ),
                                 tags$hr(),
                                 p("Use these buttons to filter the data by company size and type"),
                                 radioButtons(
                                   inputId = "size1",
                                   label = "Business Size",
                                   choices = c("Overall","Small", "Mid", "Large"),
                                   selected = c("Small")
                                 ),
                                 radioButtons(
                                   inputId = "type1",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   label = "Business Type",
                                   choices = c("Overall","Private", "State Gov.", "Local Gov."),
                                   selected = c("Private")
                                 )
                                 ),
                #Create page two conditional side bar
                conditionalPanel(condition = "input.navMenu == 'location'",
                                 h4("Analysis of Workplace Injury by Location"),
                                 tags$hr(),
                                 p("Use this button to filter the data by company size"),
                                 radioButtons(
                                   inputId = "size2",
                                   label = "Business Size",
                                   choices = c("Overall","Small", "Mid", "Large"),
                                   selected = c("Small")
                                 ),
                                 tags$hr(),
                                 p("Move the slider to select the number of businesses to display on the map. They are arranged in descending order by days away from work"),
                                 sliderInput(
                                   inputId = "topx",
                                   label = "Top x Businesses",
                                   min = 1,
                                   max = 2500,
                                   value = 50,
                                   round = TRUE
                              )
                                
                ),
                #Create page three conditional side bar
                conditionalPanel(condition = "input.navMenu == 'year'",
                                 h4("Yearly Trends in Workplace Injury and Illness"),
                                 p("Use the radio buttons to select the business size and sector specifications"),
                                 tags$hr(),
                                 radioButtons(
                                   inputId = "size3",
                                   label = "Business Size",
                                   choices = c("Overall","Small", "Mid", "Large"),
                                   selected = c("Small")
                                 ),
                                 radioButtons(
                                   inputId = "type3",
                                   label = "Business Type",
                                   choices = c("Overall","Private", "State Gov.", "Local Gov."),
                                   selected = c("Private")
                                 ),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                )
            ),
  #create UI for dashboard body of main pages
  dashboardBody(
    tabItems(
      #create UI for EDA page
      tabItem(tabName = "eda",
              h1("The Occupational Helath and Safety Dashboard"),
              h4("Adam Green"),
              h5("12/12/2022"),
              p("Navigate through this dashboard to explore United States occupational health and safety data.  On the page below you can explore general information about key performance indicators. On subsequent pages, discover trends in occupational health related to location and reporting year. Use the input buttons on the left to filter data and use the KPI's page to get more information on variables of interest."),
              tags$hr(),
              h3("Exploratory Analysis of Key Indicators"),
              p("Use the radio buttons on the left to filter the dataset. The Injuries plot also has the option to select which indicator you would like to view as the response variable. Summary statistics next to the plot can also be filtered to view average values vs. totals"),
              tags$br(),
              
              #html/css needed to fomat box styles used throughout pages
              fluidRow(tags$style(
                ".nav-tabs-custom, .box{
      border-top: none;
      border-radius: 10px;
      border-left: 5px solid #D55E00;
      box-shadow: 0 1px 1px rgb(0 0 0 / 10%);
    }
    .box:hover, .nav-tabs-custom:hover {
      box-shadow: 0px 10px 10px 0px rgb(0, 0, 0, 0.3);
    }
    .nav-tabs-custom .nav-tabs li.active {
	border-top-color: #D55E00;
	 
}
    
"
              ),
                tabBox(width=9,
                       id = "tab1",
                       tabPanel("Injuries", "", plotOutput("totals")),
                       tabPanel("Illnesses", "", plotOutput("specific"))
              ),
              #Create UI for summary statistics
              column(width = 3, 
                  selectInput("avg", label = "Select Statistic", choices = c("Average", "Total"), selected = "Average"),
                  box(width = "100%", strong("Injuries:"),
                      textOutput("injStat")),
                  box(width = "100%", strong("Days Away:"), textOutput("dafwStat")),
                  box(width = "100%", strong("Company Count:"), textOutput("count")),
                  box(width = "100%", strong("Injury Rate:"), textOutput("rateStat")),
                  box(width = "100%", strong("Days Missed Per Case"), textOutput("severity"))
                  )
      
            ),
            h3("Leaders in Total Number of Injuries and Illnesses"),
            p("Use the Tables Below to explore companies and industries that recorded the highest number of injuries and illnesses in 2020"),

            fluidRow(
                box(width = 6, tableOutput("totalTab")),
                box(width = 6, tableOutput("specificTab"))
                ),
      h3("Explore the Relationship Between Mean Injuries and Mean Illnesses"),
      p("The label plot below outlines the specific industries plotted by mean number of injuries and mean illnesses. The most dangerous industries from a occupational health standpoint are those in the top right corner.  Industries in the top left and bottom right corners should also be noted as well for their dangers."),
      fluidRow(
        box(width = 12, plotOutput("deathsplot"))
      )),
      
      #Create UI for locational Analysis page
      tabItem(
              tabName = "location",
              h2("Explore Locational Data"), 
              p("On this page, you can view the locational distribution of the businesses with the highest rates of workplace injury and days away from work. You can customize the number and size of businesses you see using the items on the sidebar. 
                Hover over an icon to view the company name. Click on an icon to view the state it is located in."),
              tags$br(),
              fluidRow(
                box(width = 6, strong("Average Injuries for Displayed Companies:"), textOutput("locInj")),
                box(width = 6, strong("Average DAFW for Displayed Companies:"), textOutput("locDafw"))
               ),
              fluidRow(
                box(width = 12, leafletOutput("map"))
      ),
      h3("Further Locational Analysis"),
      p("The following plot and table further indicate locational trends in occupational health and safety.  Filter the data to view the states with highest rates of injury and illness"),
      fluidRow(
        box(width = 12, plotOutput("statePlot"))
      ),
      fluidRow(
        box(width = 3, p("The table on the right displays summary information for injury reports.  The data has been grouped by state and ranked based on total injury count. The far right column indicates the industry that appeared most commonly in the given state")),
        box(width = 9, tableOutput("tabState"))
      )
    ),
    #Create UI for yearly analysis page
    tabItem(
            tabName = "year",
            h2("Yearly Trends in Occupational Health and Safety"),
            p("The figures on this page display a range of comparisons across reporting years of workplace injury and illness.  Trends in occupational health across years can provide indication of improvements and deficits in workplace safety policy. The summary statistics provided indicate the mean number of injuries experienced by businesses in 2017 and 2020"),
            tags$br(),
            fluidRow(
              box(width = 9, plotOutput("yearlyIll")),
              column(width = 3,
                     box(width = "100%",strong("Average Injuries 2017:"), textOutput("2017")),
                     box(width = "100%",strong("Average Injuries 2018:"), textOutput("2018")),
                     box(width = "100%",strong("Average Injuries 2019:"), textOutput("2019")),
                     box(width = "100%",strong("Average Injuries 2020:"), textOutput("2020")))
              ),
            tags$br(),
            h3("Distribution of Illness Types By Year"),
            p("The plot below depicts the total number of illnesses (including hearing loss and poisonings) across years.  The segments in this plot represent the breakdown of each years illnesses by specific illness type. This plot is useful in describing occupational disease trends to infer the occupational illness landscape for the coming year."),
            fluidRow(
              box(width = 12, plotOutput("all_ill"))
            ),
            tags$br(),
            h3("Explore the Impact of COVID-19 on Occupational Respiratory Illness Cases"),
            p("The figures below specifically display statistics related to occurences of respiratory illness by year."),
            fluidRow(
              box(width = 6, tableOutput("yearlyMissed")),
              box(width = 6, plotOutput("yearlyInj")),
              ),
            
    ),
    #Read in KPIs from rmd file 
    tabItem(
        tabName = "kpi",
        h1("Explanation of Key Indicators"),
        includeMarkdown("KPIs.Rmd")
    )
  )))

# Define server logic required to draw a histogram
server <- function(input, output) {

#apply input filters for page one
totals_hist<- reactive({
  if(input$type1 != "Overall"){dd = data%>% filter(establishment_type %in% input$type1)} 
  else{dd = data}
  if(input$size1 != "Overall"){dd_fin = dd%>% filter(size %in% input$size1)}
  else{dd_fin = dd}
  return(data.frame(dd_fin))
})

#add total illnesses column to dataset
with_ill<- reactive({
  totals_hist() %>% mutate(tot_ill = total_poisonings + total_respiratory_conditions+total_skin_disorders+total_hearing_loss+total_other_illnesses )
})


rows<- reactive({
  nrow(totals_hist())
})

#Create Summary Statistics
stat1<- reactive({
  if (input$avg == "Average"){met = mean(totals_hist()$total_injuries)}
  else{met = sum(totals_hist()$total_injuries)}
  return(met)
})

stat2<- reactive({
  if (input$avg == "Average"){met = mean(totals_hist()$total_dafw_days)}
  else{met = sum(totals_hist()$total_dafw_days)}
  return(met)
})

stat3<- reactive({
  ((sum(totals_hist()$total_injuries))*200000)/(sum(totals_hist()$total_hours_worked))
})

stat4<- reactive({
  (sum(with_ill()$total_dafw_days))/(sum(with_ill()$total_injuries) + sum(with_ill()$tot_ill))
})

#Produce output of summary statistics
output$count <- renderText({rows()})
output$injStat <- renderText({round(stat1(), 2)})
output$dafwStat <- renderText({round(stat2(), 2)})
output$rateStat <- renderText({round(stat3(), 2)})
output$severity<- renderText({round(stat4(), 2)})

#Reactive functions to arrange data for EDA plots and tables
df<- reactive({
  totals_hist() %>% select(id, total_injuries, total_deaths, total_dafw_days, total_dafw_cases, annual_average_employees, size, total_hours_worked)
})

display_dafw<- reactive({
  if(input$disp == "Days Away from Work"){dat = select(df(), "annual_average_employees", "total_dafw_days", "total_deaths")}
  else{dat = select(df(), "annual_average_employees", "total_injuries", "total_deaths")}
  return(data.frame(dat))
})

final_dafw<- reactive({
  display_dafw() %>% mutate(death =
         case_when(total_deaths == 0 ~ "False", 
                   total_deaths > 0 ~ "True"))
})

#Reactive function to cast y axis label
ytitle_dafw <- reactive({
  if(input$disp == "Days Away from Work"){ylabel = "Total Days Away from Work"} 
  else{ylabel = "Total Injuries"}
})


title_dafw <- reactive({
  if(input$disp == "Days Away from Work"){title = "Total Days Away from Work vs. Average Employee Count"} 
  else{title = "Total Injuries vs. Average Annual Employees"
  }
})

#Create plot for injuries tab on EDA page
output$totals<- renderPlot({
  ggplot(data = display_dafw())+
    geom_point(aes(x = annual_average_employees, y = display_dafw()[, 2], color= final_dafw()$death))+
    scale_color_manual(values = cbp2, name = "Death Occured")+
    labs(x = "Average Annual Employees", y = ytitle_dafw(), title = title_dafw())+
    theme(axis.title = element_text(size = 14), legend.title = element_text(size = 14), plot.title= element_text(size = 18), legend.text = element_text(size = 12), legend.position = "right")
})


#Create output for second tab on eda page
df_spec<- reactive({
  totals_hist() %>% select(id, total_poisonings, total_respiratory_conditions, total_skin_disorders, total_hearing_loss, total_other_illnesses, annual_average_employees, size, total_hours_worked, total_deaths)%>%
   mutate(total_illnesses = total_poisonings + total_respiratory_conditions+total_skin_disorders+total_hearing_loss+total_other_illnesses)%>%
    filter(total_illnesses >0)%>%
     mutate(death = case_when(total_deaths == 0 ~ "False", 
                                          total_deaths > 0 ~ "True"))
})

#Create output for illnesses tab on EDA page
output$specific <- renderPlot({
  ggplot(data = df_spec())+
    geom_point(aes(x = annual_average_employees, y = total_illnesses, color = death))+
    scale_color_manual(values = cbp2, name = "Death Occured")+
  labs(title = "Total Illnesses vs. Average Annual Employees", x = "Average Annual Employees", y = "Total Illnesses")+
    theme(axis.title = element_text(size = 14), legend.title = element_text(size = 14), plot.title= element_text(size = 18), legend.text = element_text(size = 12), legend.position = "right")
  })


#Create output for eda plot three using reactive functions 
label_df1<- reactive({
  totals_hist() %>% mutate(total_illnesses = total_poisonings + total_respiratory_conditions+total_skin_disorders+total_hearing_loss+total_other_illnesses)%>%
    filter(total_illnesses>0, total_injuries>0)
})

label_df2<- reactive({
  label_df1()%>% group_by(industry_description)%>%summarize(total_ill = mean(total_illnesses), total_inj = mean(total_injuries))
})

label_df3<- reactive({
  remove_outlier(label_df2(), c("total_inj"))
})

output$deathsplot<- renderPlot({
  ggplot(data = label_df2(), aes(label = industry_description))+
    geom_label(aes(x = total_ill, y = total_inj), label.size = 0.1, label.r = unit(0.2, "lines"))+
    labs(title = "Explore Industry Variations in Mean Illnesses vs. Mean Injuries", x = "Mean Illnesses", y = "Mean Injuries")+
    theme(axis.title = element_text(size = 14), plot.title= element_text(size = 18))
})

#Create output for eda table 1
final_totals<- reactive({
  totals_hist()[order(totals_hist()$total_injuries, decreasing = TRUE),]
})

extra_total<- reactive({
  final_totals()[1:10, ] %>% select("company_name", "industry_description", "total_injuries") %>% 
    rename("Company Name" = company_name, "Industry" = industry_description,  "Total Injuries" = total_injuries)
})

#create table output for injuries
output$totalTab <- function() {
  mid<- extra_total() %>%
    knitr::kable("html") %>%
    kable_styling(full_width = F, "striped")
  remove_column(mid, 1)
}

#Create output for eda table 2
illness_group<- reactive({
  totals_hist() %>% mutate(total_illnesses = total_poisonings + total_respiratory_conditions+total_skin_disorders+total_hearing_loss+total_other_illnesses)
})

final_ill<- reactive({
  illness_group()[order(illness_group()$total_illnesses, decreasing = TRUE),]
})

extra_ill<- reactive({
  final_ill()[1:10, ] %>% select("company_name", "industry_description", "total_illnesses")%>% 
    rename("Company Name" = company_name, "Industry" = industry_description,  "Total Illnesses" = total_illnesses)
})

#create table output for illnesses
output$specificTab <- function() {
  mix<- extra_ill() %>%
    knitr::kable("html") %>%
    kable_styling(full_width = F, "striped") 
  remove_column(mix, 1)
}

#Create map output
mapdat<- reactive({
  if(input$size2 !="Overall"){dd = data%>% filter(size %in% input$size2)} else{dd = data}
  return(data.frame(dd))
  })

#order businesses by total days away from work
final_map<- reactive({
  mapdat()[order(mapdat()$total_dafw_days, decreasing = TRUE),]
})

#select top x businesses
fin<- reactive({
  final_map()[1:input$topx,]
})


#create summary statistics for locational analysis
locS1<- reactive({
 round(mean(fin()$total_injuries), 2)
})
locS2<- reactive({
  round(mean(fin()$total_dafw_days), 2)
})

output$locInj<- renderText({locS1()})
output$locDafw<- renderText({locS2()})

#create map object to view trends in location for workplace days away from work
output$map<- renderLeaflet({
  leaflet(data = fin())%>%
 setView(lat = usaLat, lng = usaLon, zoom = usaZoom) %>%
                         addTiles() %>%
                         addMarkers(lng = ~lng,lat = ~lat, 
                                    popup = fin()$state, 
                                    popupOptions = popupOptions(max_width = 400, maxHeight = 200, keepInView = TRUE),
                                    label = ~company_name, 
                                    icon = businessIcon, labelOptions = labelOptions(interactive = TRUE,
                                                                                     permanent = FALSE,
                                                                                     textsize = "8px")) 

})

df_state<- reactive({
  mapdat() %>% select(id, total_injuries, annual_average_employees, size, total_hours_worked, state)%>%
    group_by(state)%>% summarize(mean_injuries = mean(total_injuries), mean_hours_worked = mean(total_hours_worked))
})

final_dat<- reactive({
  df_state()[order(df_state()$mean_injuries, decreasing = TRUE),]
})

#create plot to define mean injuries by state
output$statePlot <- renderPlot({
  ggplot(data = final_dat(), aes(x = reorder(state, desc(mean_injuries)), y = mean_injuries, fill = mean_hours_worked))+
    geom_chicklet(radius = grid::unit(1, "mm"))+
    scale_fill_gradient2(low = cbp2[2], high = cbp2[1], name = "Mean Hours Worked")+
    theme(axis.text.x = element_text(angle = 90))+
    labs(title = "Mean Injuries, Grouped By State, Coloured By Mean Hours Worked", x = "State", y = "Mean Number of Injuries")+
    theme(axis.title = element_text(size = 14), legend.title = element_text(size = 14), plot.title= element_text(size = 18), legend.text = element_text(size = 12), legend.position = "right")
})

#Create table of top states by injury
tab_state<- reactive({
  mapdat() %>% select(id, total_injuries, annual_average_employees, size, total_hours_worked, state, industry_description)%>%
    group_by(state)%>% summarize(mean_injuries = round(mean(total_injuries), 2), total_injuries = sum(total_injuries),  mean_hours_worked = mean(total_hours_worked), common_ind = getmode(industry_description))
})

tab_ordered<- reactive({
  tab_state()[order(tab_state()$total_injuries, decreasing = TRUE), ][1:15, ]%>% 
    rename("State" = state, "Mean Hours Worked" = mean_hours_worked, "Mean Injuries" = mean_injuries,  "Total Injuries" = total_injuries, "Most Common Industry" = common_ind)
})

output$tabState <- function() {
  tab_ordered() %>%
    knitr::kable("html") %>%
    kable_styling("striped", full_width = F)
}


#Create yearly trend output for injuries
year<- reactive({
  if(input$type3 != "Overall"){dd = data2%>% filter(establishment_type %in% input$type3)} 
  else{dd = data2}
  if(input$size3 != "Overall"){dd_fin = dd%>% filter(size %in% input$size3)}
  else{dd_fin = dd}
  return(data.frame(dd_fin))
})

#create summary statistics for yearly analysis
yearS1<- reactive({
  year()%>% filter(year_filing_for == 2020)
})

yearS2<- reactive({
  year() %>% filter(year_filing_for == 2017)
})

yearS3<- reactive({
  year() %>% filter(year_filing_for == 2018)
})

yearS4<- reactive({
  year() %>% filter(year_filing_for == 2019)
})

#output for summary statistics  
output$`2017`<- renderText({round(mean(yearS2()$total_injuries), 2)})
output$`2018`<- renderText({round(mean(yearS3()$total_injuries), 2)})
output$`2019`<- renderText({round(mean(yearS4()$total_injuries), 2)})
output$`2020`<- renderText({round(mean(yearS1()$total_injuries), 2)})

#reactive functions to arrange data for yearly analysis plots and tables
year_group<- reactive({
  year() %>% mutate(total_illnesses = total_poisonings + total_respiratory_conditions+total_skin_disorders+total_hearing_loss+total_other_illnesses)%>%
    filter(total_illnesses>0)
})

year_all<- reactive({
  year_group()%>% mutate(total_inj_ill = total_illnesses + total_injuries)%>%
    filter(total_inj_ill>0) %>% group_by(year_filing_for)%>% summarize(mean_inj_ill = mean(total_inj_ill), total_inj = sum(total_injuries), total_hours_worked = sum(total_hours_worked))
})

test<- reactive({
  year_group()%>% mutate(total_inj_ill = total_illnesses + total_injuries)%>%
    filter(total_inj_ill>0) %>% group_by(year_filing_for)%>% summarize(total_resp = sum(total_respiratory_conditions), sum_dafw = sum(total_dafw_days), total_illness = sum(total_illnesses-total_respiratory_conditions))
})

test_extra<- reactive({
  test()[order(test()$total_resp, decreasing = TRUE), ] %>% 
    rename("Reporting Year" = year_filing_for, "Total Respiratory Illness" = total_resp,  "Total Days Away from Work" = sum_dafw, "Total Other Illness" = total_illness)
})

year_dafw<-reactive({
  year()%>%filter(total_dafw_days>0) 
})

#create plot to observe changes in injury frequency by year
output$yearlyIll <- renderPlot({
  ggplot(data = year_all(), aes(x = year_filing_for, y = total_inj, fill = total_hours_worked))+
    geom_chicklet(radius = grid::unit(2, "mm"))+
    geom_line(aes(x = year_filing_for, y = total_inj))+
    scale_fill_gradient2(low = cbp2[2], high = cbp2[1], name = "Total Hours Worked")+
    labs(title = "Total Number of Injuries by Year",x = "Year", y = "Total Injuries")+
    theme(axis.title = element_text(size = 14), legend.title = element_text(size = 14), plot.title= element_text(size = 18), legend.text = element_text(size = 12), legend.position = "right")
})

#create table to explain statistics related to occurences of respiratory illness
output$yearlyMissed<- function() {
  test_extra() %>%
    knitr::kable("html") %>%
    kable_styling("striped", full_width = F)
}

#Create plot to define occurences of respiratory illness
output$yearlyInj<- renderPlot({
  ggplot(data = test(), aes(x = year_filing_for, y = total_resp, fill = total_illness))+
    geom_chicklet(radius = grid::unit(2, "mm"))+
    scale_fill_gradient2(low = cbp2[2], high = cbp2[1], name = "Other Illnesses")+
    geom_line(aes(x = year_filing_for, y = total_resp))+
    labs(title = "Respiratory Illnesses by Year", x = "Year", y = "Total Number of Respiratory Illnesses")+
    theme(axis.title = element_text(size = 14), legend.title = element_text(size = 12), plot.title= element_text(size = 18), legend.text = element_text(size = 10), legend.position = "right")
})

#Pivot the table to create counts of individual illnesses as rows
pivoted<- reactive({
  year() %>% select(total_poisonings, total_respiratory_conditions, total_skin_disorders, total_hearing_loss, total_other_illnesses, establishment_type, size, year_filing_for)%>%
    rename("Poisonings" = total_poisonings, "Respiratory" = total_respiratory_conditions, "Skin" = total_skin_disorders, "Hearing" = total_hearing_loss, "Other"= total_other_illnesses)%>%
    pivot_longer(cols = c(Poisonings, Respiratory, Skin, Hearing, Other), names_to = "Measure", values_to = "count")
})

#Create stacked bar plot to define distribution of illness types
output$all_ill<- renderPlot({
  ggplot(data = pivoted(), aes(x = year_filing_for, y = count, fill = Measure))+
    geom_bar(position = "stack", stat = "identity")+
    scale_fill_manual(values = cbp2[1:5])+
    labs(title = "Distribution of Illness Types by Year", x = "Year", y = "Total Number of Illnesses")+
    theme(axis.title = element_text(size = 14), legend.title = element_text(size = 14), plot.title= element_text(size = 18), legend.text = element_text(size = 12), legend.position = "right")
})
}

# Run the application 
shinyApp(ui = ui, server = server)
